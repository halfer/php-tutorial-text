

<h2>Adding some polish</h2>

<p>
	Excellent, we're now on the home straight! Our functionality is finished, so we'll just
	do a last round of sprucing up. To start, let's add in a home link for authorised users. This
	is useful on the restricted pages, since they don't have a home link themselves:
</p>

<?php renderDiffFromComment('Add in home link for auth users') ?>

<p>
	Next, I thought it would be nice to have a comment count for each article on the All Posts page.
	Add the following changes:
</p>

<?php renderDiffFromComment('Add in comment count for each post') ?>

<p>
	Let's take a closer look at how the new query works. The query now looks like this:
</p>

<blockquote class="code">
<pre><code>SELECT
	id, title, created_at, body,
	(SELECT COUNT(*) FROM comment WHERE comment.post_id = post.id) comment_count
FROM
	post
ORDER BY
	created_at DESC</code></pre>
</blockquote>

<p>
	The new part of this is the bracketed expression on the third line. This
	sort of SQL is known as a <em>sub-query</em> since it is a query contained inside another
	one. The result of it can be read like a real column, which we explicitly name by adding
	<code>comment_count</code> at the end of it.
</p>

<p>
	This sub-query will count rows in the <code>comment</code> table, based on which post they
	belong to. Since the job of the outer query is to list posts, we can filter the comment count
	for each row by making a comparison to the outer table, <code>post</code>.
</p>

<p>
	The next change is another easy one: we'll add a header row to the All Posts table:
</p>

<?php renderDiffFromComment('Add heading to All Posts table') ?>

<p>
	While we are on the All Posts page, it would make sense to add in a link to the view page
	for each article. So let's do that now:
</p>

<?php renderDiffFromComment('Add view link from All Posts admin page') ?>

<p>
	Next up is a refactoring that simplifies the code (quite a bit is removed) and reduces the
	number of calls made to the database. The essence of the modification is in
	<span class="filename">lib/view-post.php</span> &mdash; we merge two SQL calls together via
	another sub-query.
</p>

<p>
	There's quite a few files to modify here, so make sure you get them all.
</p>

<?php renderDiffFromComment('Merge comment-counting into get post query') ?>

<p>
	I noticed when doing some testing at this point that posts which have comments cannot be
	deleted - try that now. You'll get an error known as a <em>foreign key constraint violation</em>;
	this is what happens when a row is deleted that a foreign key depends on (in our case we
	are trying to delete a post to which comments are still attached). To fix this, comments
	should be deleted first, prior to the post being deleted:
</p>

<?php renderDiffFromComment('Allow posts that have comments to be deleted') ?>

<p>
	Whilst we are looking at the database side of things, I noticed that the
	<code>user.is_enabled</code> field hasn't yet been used. This was intended mainly for future
	enhancements (in particular for a user administration page), but the application can make an
	initial use of it immediately, by disallowing authenticated features to non-enabled users.
</p>

<p>
	The installer sets the test user to <code>is_enabled=1</code> already, so all we need
	to do is to adjust the SQL statements that fetch data from the user table.
</p>

<?php renderDiffFromComment('Only look up users who are enabled') ?>

<p>
	Our final improvement is to add some labels and make use of existing form styles:
</p>

<?php renderDiffFromComment('Upgrade login form with global CSS features') ?> 

<p>
	Well done, you have finished the tutorial! It is a good idea to regenerate the database one last
	time, and then give the whole application a thorough testing. Add some posts and comments, both
	while logged in and while logged out, and delete comments in the admin interface.
</p>
