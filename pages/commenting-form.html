

<h2>Commenting form</h2>

<p>
	Righto, let's get onto a new solid block of functionality: allowing users to add comments.
	This adds a new block of HTML in <span class="filename">comment-form.php</span>, which
	reports any errors when the comment is made, a form to capture the usual comment information,
	and some business logic in <span class="filename">lib/view-post.php</span> and
	<span class="filename">view-post.php</span> to glue it all together.
</p>

<?php renderDiffFromComment('Add basic commenting form, validation and db error handling') ?>

<p>
	Let us have a look in detail at <span class="filename">view-post.php</span>, which is the page
	called by the web server when a single post is rendered. In the newly inserted code, we take
	these actions:
</p>

<ol>
	<li>Reset the errors variable to null i.e. we do not yet know if they are any errors.</li>
	<li>Detect if we are in a POST operation. If we are not (i.e. the page is just being rendered
		normally, rather than submitting a form) then don't do any more of this new stuff.</li>
	<li>Get the author name, website URL and comment message, and pass them to new
		function <code>addCommentToPost()</code> for validation and saving.</li>
	<li>This will return any resulting errors into the <code>$errors</code> array.</li>
	<li>If the comment-adding function successfully saves a comment to the database,
		redirect to self and exit. This will request the page again in GET mode.</li>
	<li>If the comment save failed (perhaps because a mandatory field was not supplied) then
		the errors array will contain the error message(s). Since this skips the
		redirection phase, the form is rendered within the same call, which allows the errors
		to be marked on the form.</li>
</ol>

<?php if (showTodoMessages()): ?>
	<div class="comment note">
		If we get stuck for space, we could move this sidebar to the earlier
		place where we refactored the installer from GET to POST.
	</div>
<?php endif ?>

<div class="sidebar">
	<div class="heading">
		<p>What are GET and POST?</p>
	</div>

	<p>
		I've used these phrases a few times without explaining them, so let me do that now. GET and
		POST are two kinds of <strong>HTTP operation</strong>, and can be thought of rather like a
		mode that a web-connected device (like a browser or a server) operates in. Any web address
		can be visited in either mode, and the web application can take a different course of
		action depending on the mode used.
	</p>
	<p>
		When we visit a web site normally &mdash; such as the home page of our blog, say &mdash;
		we are in GET mode. This is the state that is suitable for <em>reading</em> things from
		a web server. Some pages containing a <code>&lt;form&gt;</code> also operate in GET mode,
		such as search forms, since these too are used to read information.
	</p>
	<p>
		Forms that may result in data being saved, on the other hand, should use POST. You can
		see this with the comment form we just installed; have a look for the
		<code>method="post"</code> declaration in the form tag.
	</p>
	<p>
		This was one of the reasons behind the earlier change to the installer: before the
		modification, visiting the URL would reset the database, which breaks the rule that GET
		operations are only for reading data. Swapping this to a POST form solved the issue.
	</p>
</div>

<?php if (showTodoMessages()): ?>
	<div class="comment note">
		I've added this hash deliberately in the wrong order - I felt it was best to do this before the
		validation failure thing. In the long term maybe it would be simpler just to merge this
		with the code that introduces the feature?
	</div>
<?php endif ?>

<p>
	Adding a comment doesn't work yet, as the <code>INSERT</code> command is missing a value for
	the date of comment creation. Let's fix that now:
</p>
	
<?php renderDiffFromComment('Add timestamp to insert so comment device works') ?>

<p>
	So, that gets the success case working. However, if you test a failure condition (empty name
	field or an empty comment, the fields that <em>were</em> filled in now disappear. This is because
	a form does not by default contain values, so we have to add them manually.	
</p>

<p>
	Thus, we now set empty values for the GET case (no form submission) in
	<span class="filename">view-post.php</span> as well as
	the already existing POST case. Where we output the user-supplied data, we pass it through
	the PHP function <code>htmlspecialchars()</code>, which prevents any rendering problems if the
	user has used any HTML characters such as angle brackets.
</p>

<?php if (showTodoMessages()): ?>
	<div class="comment note">
		We <em>could</em> split the comment in <span class="filename">comment-form.php</span>
		as one of those vars is already in use, but it's not important.
	</div>
<?php endif ?>

<?php renderDiffFromComment('Persist comment form data in case of validation') ?>

<?php if (showTodoMessages()): ?>
	<div class="comment note">
		These last five items are refactoring/tidying. If this page gets too long, we could move
		a couple of them to the next page?
	</div>
<?php endif ?>

<p>
	And now for some more tidying. The first tweaking opportunity I noticed was that the code to
	make a comment safe to render to the screen, and to swap newlines for paragraph tags, might be
	useful elsewhere in the future. So I've generalised that snippet of code in a function, and
	then made use of it:
</p>

<?php renderDiffFromComment('Render paragraphs in comments') ?>

<p>
	A nice simple one is up next. The code for <span class="filename">install.php</span> was
	rather bloated by the presence of the
	large function at the start, and there's no reason why this couldn't be stored separately,
	making the installer page easier to maintain. We refactored this one a while ago, but it's
	perfectly fine to refactor again &mdash; the process can be regarded as fairly iterative
	anyway. So here's the diff, resulting in new file
	<span class="filename">lib/install.php</span>:
</p>

<?php renderDiffFromComment('Move install logic to separate file') ?>

<p>
	When a comment is created, we use a snippet of code to create a timestamp in a format suitable
	for the database server. Since that'll be useful for other things, let's convert that to a
	reusable function:
</p>

<?php renderDiffFromComment('Refactor SQL timestamp into new func, we\'ll need this next') ?>

<p>
	I noticed that the installer creates its own database connection. Although there was no
	pressing need to do so, I modified it so it uses a connection passed to it. This would make it
	easier to run automated tests against it, for example &mdash; a custom test connection would be
	passed to it, rather than the "hard-wired" one we have now removed.
</p>

<?php renderDiffFromComment('Send PDO object to create db function') ?>

<p>
	The last tweak is very easy: a re-reading of some of the code showed that I'd not updated
	a comment in line with a code change. Now, I could magic this away for the benefit of the
	tutorial, but I rather like the opportunity to show that code is never perfect, and that
	sometimes comments come out of sync with what they're meant to describe! So, just apply the
	following diff, and we're done for this chapter.
</p>

<?php renderDiffFromComment('Fix up out-of-date comment') ?>

