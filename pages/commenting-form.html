

<h2>Commenting form</h2>

<p>
	Righto, let's get onto a new solid block of functionality: allowing users to add comments.
	This adds a new block of HTML in comment-form.php, which reports any errors when the comment
	is made, a form to capture the usual comment information, and some business logic in
	lib/view-post.php and view-post.php to glue it all together.
</p>

<?php renderDiff('109bd357fdc29c189081810f1da2fa0199661d6b') ?>

<p>
	Let us have a look in detail at view-post.php, which is the page called by the web server
	when a single post is rendered. In the newly inserted code, we take these actions:
</p>

<ol>
	<li>Reset the errors variable to null i.e. we do not yet know if they are any errors.</li>
	<li>Detect if we are in a POST operation. If we are not (i.e. the page is just being rendered
		normally, rather than submitting a form) then don't do any more of this new stuff.</li>
	<li>Get the author name, website URL and comment message, and pass them to new
		function <code>addCommentToPost()</code> for validation and saving.</li>
	<li>This will return any resulting errors into the <code>$errors</code> array.</li>
	<li>If the comment-adding function successfully saves a comment to the database,
		redirect to self and exit. This will request the page again in GET mode.</li>
	<li>If the comment save failed (perhaps because a mandatory field was not supplied) then
		the errors array will contain the error message(s). Since this skips the
		redirection phase, the form is rendered within the same call, which allows the errors
		to be marked on the form.</li>
</ol>

<?php if (showTodoMessages()): ?>
	<div class="todo">
		If we get stuck for space, we could move this sidebar to the earlier
		place where we refactored the installer from GET to POST.
	</div>
<?php endif ?>

<div class="sidebar">
	<div class="heading">
		<p>What are GET and POST?</p>
	</div>

	<p>
		(todo: make a reference that we refactored the installer from GET to POST, and why we did
		that)
	</p>
</div>

<?php if (showTodoMessages()): ?>
	<div class="todo">
		Currently finished writing up to here.
	</div>
<?php endif ?>

<p>
	[Handle the case of failed validation - if we fail validation, are there PHP warnings we are trying to plug?]
</p>

<?php renderDiff('51582d22e7ace119cee6d6023f2a0351cd0d6505') ?>

<p>Add timestamp to insert so comment device works:</p>

<?php renderDiff('56046941508c1d47b1e36180e2245e6dfa6bac9c') ?>

<p>Render paragraphs in comments</p>
<?php renderDiff('fcf4ab21a9bae2bf86f0d26cc0acc1309a0c789b') ?>

<?php if (showTodoMessages()): ?>
	<div class="todo">
		These last four items are refactoring/tidying. At the least this section should be declared,
		as per the last page, and if this page gets too long, we could move a couple of them to the
		next page?
	</div>
<?php endif ?>

<p>Move install logic to separate file</p>
<?php renderDiff('81865f2f16d7237a4f9864f3756e5dce05e9e147') ?>

<p>Refactor SQL timestamp into new func, we'll need this next</p>
<?php renderDiff('38d6c09faf1721560de1b6182cb477afb4110aa1') ?>

<p>Send PDO object to create db function</p>
<?php renderDiff('ed6aaadb0045735b2d723bc67967076958589ae5') ?>

<p>Fix up out-of-date comment</p>
<?php renderDiff('d28456262905f8e334903bc827325c7d062119a2') ?>

