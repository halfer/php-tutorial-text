<h2>Introduction</h2>

<p>
	In this tutorial, I'll present how to write a simple blog system, using the PHP language and
	the Apache web server. For the database, we'll use SQLite, to keep things simple. Don't worry
	if these terms don't mean anything yet, that's okay. I'm assuming readers are familiar
	with how to use their computer, but perhaps have not programmed before. That said, even a
	beginner's tutorial can get non-trivial quickly, so if you are brand new to programming, you
	may wish to research unfamiliar keywords (usually on the PHP website).
</p>

<p>
	The application we will build together was built prior to writing the tutorial. The text is
	therefore written around the way I think development happens in real life; some steps may
	introduce bugs, or be written in ways the purist might consider non-ideal. However, for the most
	part, these problems will be ironed out as we go. At the end of this project, we'll have a
	<b>functional</b>, <b>maintainable</b> and <b>secure</b> application, but there'll be much
	that can still be improved on (which will likely make for a subsequent tutorial).
</p>

<p>
	If you are new to programming, it is possible that you might feel somewhat lost as you work
	through the material. Whilst any prior practice will always help, the before-and-after code
	samples should see you right through to the end, even if you don't initially understand every
	step. You should find that some of this will sink in, and will contribute to your future "aha"
	moment, even if it is daunting at the start. The elation of getting it working will, I hope,
	encourage you to dive even deeper into programming. Enjoy the ride!
</p>

<blockquote class="sidebar">
	<div class="heading">
		<p>A word about PHP tutorials on the web</p>
	</div>
	<p>
		To become proficient with a programming language, it makes sense to obtain your learning
		materials from as wide a source as possible. PHP owes its success, I think, to its very
		low barriers to entry, but that situation has given birth to plenty of tutorials on the
		Internet that make two fundamental errors.
	</p>
	<p>
		The first is that the <code>mysql_</code> library is still in use (a <em>library</em> is
		just a package of useful functions). This has been a staple of database access
		in PHP applications for some ten years, but has now been superceded by newer systems.
		In particular, libraries such as PDO and mysqli offer <em>parameterisation</em>, a feature
		that helps prevent miscreants and ne'erdowells from cracking system security.
	</p>
	<p>
		The other problem I see a great deal of are tutorials that interleave <em>business logic</em>
		(what an application does) with <em>layout</em> (what an application looks like).
		This isn't wrong exactly, but having separation between the two does tend to make
		for systems that are more maintainable.
	</p>
</blockquote>

<p>
	I'll assume that your development environment is set up. Here's what you will need:
</p>

<ul>
	<li>Web server, usually Apache</li>
	<li>PHP; anything over 5.3.7 is fine, although the latest version is usually best</li>
	<li>SQLite PHP module</li>
</ul>

<p>
	For Windows users, you can get all of this with WAMP, and for Mac users you can install
	MAMP. If you use Linux, you may have all of this already. If you get stuck, turn to your favourite
	search engine, and ask "How do I install [whatever] on [Windows]". In 99% of cases, your question has
	already been answered, so be persistent.
</p>

<p>
	You'll also need an editor to modify files. Most computers have a free text editor already
	installed, but these are rarely good enough. Use whatever you like, but if you have no
	preference, download and install NetBeans.
</p>

<div class="intermission">~</div>

<p>
	In designing this tutorial, I wrote out a list of things I thought would be great to have, and
	then developed until I had a basic complete product. In retrospect, it would have been better to
	decide this prior to development; regardless of whether you are setting up a business or programming
	for fun, having a simple and achievable plan is miles better than an all-singing,
	all-dancing one that ends up abandoned half-way through (either through boredom, bankruptcy, or
	both).
</p>

<p>Here's the initial list of features/technologies I put on paper:</p>

<blockquote class="list">
	<p>
		Login, Logout, Add comment, Create user, Amend user, Delete user, Email validation for new user
		accounts, Display post, Accept markdown format, Create post, Edit post, Unpublish post, Delete post,
		Unit tests, List posts, AJAX posting/commenting, Database profiler, Internationalisation,
		Pretty URLs, Use template engine, Per-environment configuration files, Post pagination,
		Comment pagination, Unpublish comment, Delete comment, Foreign key constraints, Unique constraints,
		User access levels.
	</p>
</blockquote>

<p>
	To illustrate how much an "initial working product" should trim the initial wishlist, here's
	what made it into the first version:
</p>

<blockquote class="list">
	<p>
		Login, Logout, Add comment, Display post, Create post, Edit post, Delete post, List posts,
		Delete comment, Foreign key constraints.
	</p>
</blockquote>

<p>
	It's worth pointing out that, with any software project, rejecting a feature <em>now</em> does
	not mean you can never add that feature. It just means that you are prioritising getting
	important things done, so that the product is in a releasable state quickly. Once it is out the
	door, you can then find a few more items on your list to add into the next iteration. In a
	commercial situation, this approach is helpful because if your users don't like a change you've
	made, you've wasted two months rather than two years &mdash; a saving that could be the difference
	between steering things back on track, and going bust.
</p>

<p>
	One of the other features of this tutorial is that it uses an absolute minimum of additional
	software to get it working. Software projects nearly always make use of libraries,
	each of which offer some particular pre-written functionality. These are well worth using in
	proper development, since they are better-tested by more people than an individual can usually
	achieve on their own. However, for a tutorial I think they can add integration complexity, and
	explaining the advanced-level code within is usually quite a distraction. Thus, I have eschewed
	libraries more than I would normally, and suspect this will be corrected in a second (more
	advanced) tutorial.
</p>
<p>
	I have made one exception for this rule, however, for reasons of password security. The login
	system requires some cryptographic code, and this sort of thing is quite easy to get wrong. Whilst
	this is just a tutorial, if it teaches readers to leave security to the experts (the
	library-writers), it has served a valuable purpose.
</p>

<div class="intermission">~</div>

<p>
	So, let us get started. I'll assume you know how to create, edit, save and delete files in your
	editor, and that you can create folders as required. This might be in the root of your "htdocs"
	or "www" folder, depending on what you used to install Apache. You can use a subfolder of "blog"
	if you wish, or for more advanced users, feel free to set up a new vhost. So, when I use
	<code>http://localhost/</code>, you can assume I am referring to the root of your project, even
	if your URL is somewhat different.
</p>

<p>
	Let us first check that your server installation is working okay. Create a file called
	<code>info.php</code> in the root of your project folder:
</p>

	<?php include '../templates/info.php' ?>

<p>
	Then, run this in your browser, by accessing the URL <code>http://localhost/info.php</code>.
	You should see a PHP configuration page. If you do, then check you are running a version later
	than 5.3.7; if it is earlier than this (e.g. it is still on 5.2, or an early version of 5.3) then
	you will need to upgrade. If you don't see this screen at all, then check that you have created
	the file in the right folder.
</p>

<p>
	Once you have this working, and showing an acceptable version number, you can delete this file.
</p>

<p>Here's the first bit of code to add:</p>

<div class="first">
	<?php renderDiff('8b492805bfaea954a8511994fc7030beb7ab4faa') ?>
</div>

<p>
	This is the initial file, so all we have to do is copy and paste it in. To do so, create
	"index.php" in the root of your project folder, open it in your editor, and ensure it is empty
	before pasting in the code. Then visit <code>http://localhost/index.php</code> in your browser,
	to ensure that you can see the initial mock-up of our blog's home page.
</p>

<p>
	If you can, then your first piece of coding is done! The language is HTML, which is understood
	by your web browser as a way to describe documents on the web. HTML is not actually a
	programming language: it is properly referred to as a <em>markup language</em>. The markup itself
	is made up of <em>tags</em> such as <code>&lt;body&gt;</code> and <code>&lt;h1&gt;</code>, each
	of which has an opening tag (without the slash) and a closing tag (with the slash).

	These
	are nested to form a hierarchy in the same way as an ordinary letter is hierarchical: instead of
	an envelope containing a document containing headings and paragraphs, we have an
	<code>&lt;html&gt;</code> containing a <code>&lt;body&gt;</code> containing
	<code>&lt;h1&gt;</code> and <code>&lt;p&gt;</code>. Easy peasy!
</p>

<blockquote class="sidebar">
	<div class="heading">
		<p>What do the tags mean?</p>
	</div>
	<ul>
		<li>DOCTYPE: this tells the browser to expect a particular dialect of HTML &mdash; in this
			case HTML5</li>
		<li>html: this is the "envelope" for the whole document. It acts as a container for
			everything</li>
		<li>head: this contains stuff about the document, such as the title</li>
		<li>body: unsurprisingly, this contains the main part of the document</li>
		<li>h1, h2, h3: title headings of decreasing importance</li>
		<li>p: a paragraph of text</li>
		<li>div: a "division", i.e. a section</li>
		<li>a: a hyperlink</li>
	</ul>

	<p>We'll use a few more as we go on, but those are the main ones.</p>
</blockquote>

<p>
	Let us start improving our skeleton home page. One of the observations we can make is that there
	is a fair bit of repetition: there are two articles that both have a heading, date, summary
	and hyperlink. Since this is just test data, let us add a loop around the first article block
	and delete the second one.
</p>

<p>
	Here is how I am presenting the changes in this tutorial. This will be good practice for you,
	since all changes will be shown in this way. The approach of showing code changes like this is
	known as a <em>diff</em>, for obvious reasons (though the diffs I use are more colourful than
	the usual monochrome versions).
</p>

<?php renderDiff('8e7743fc7c3c0e0f995619b54a60c338e454d7a3') ?>

<p>
	The rules for making these changes are simple: the code on the left is the old file, the code
	on the right is the new one; also, red lines are deleted, green lines are added. So, the two
	blocks on the left are in the existing file, and since they are red, they can be removed. The block
	on the right is green, so is added.
</p>
<p>
	Thus, if you wish, you can delete both article blocks and replace them with the new loop block
	(containing the <code>for()</code> through to the <code>endfor</code>). However, the way this was
	actually written was as follows:
</p>

<ul>
	<li>Delete the second article</li>
	<li>Insert the start of the <code>for</code> loop before the first article, on a new line</li>
	<li>Insert the end of the loop (<code>endfor</code>) at the end of the first article, on a new
		line</li>
	<li>Indent the contents of the loop (in most editors, you can do this by selecting the article
		markup and pressing the Tab key)</li>
	<li>Finally, the two snippets of PHP to output the <code>$postId</code> are inserted into the
		article
</ul>

<p>
	In summary, it doesn't matter too much how you apply these changes (or, indeed, any changes in
	this tutorial). That said, understanding the way in which changes are written in real
	life may help towards a greater understanding of the code. Don't worry though if you think you've
	made a mistake; the full file for each change is available above each one.
</p>

<blockquote class="sidebar">
	<div class="heading">
		<p>What are loops?</p>
	</div>
	<p>
		The <code>for</code> and <code>endfor</code> you have seen form a <em>loop</em> block. This is
		a way of telling PHP that you want the enclosed code to be run a number of times. In this
		case, it sets a value to 1, and carries on looping whilst that value is less than or greater
		than 3. For each iteration of the loop, the value is incremented by 1, which is carried out by
		the <code>++</code> operator.
	</p>
</blockquote>

<p>
	So, finally, refresh your browser screen, and make sure your changes work. You should now see
	<em>three</em> articles, each with a different heading and paragraph.
</p>

<div class="intermission">~</div>

<p>
	The next step we will take is to set up the database. We'll use a database system called
	SQLite (pronounced "See-qwel Light") as it is really easy to connect to, and does not
	require a database server. Create the following two files in your project, paste in the contents,
	and then we'll discuss what they do:
</p>

<?php renderDiff('d3bad31f6e2f6e23009e9b033952904117350263') ?>

<p>
	This change comprises of two new files, a SQL file and a PHP file. I'll discuss the SQL file
	first.
</p>

<blockquote class="sidebar">
	<div class="heading">
		<p>What is SQL?</p>
	</div>
	<p>
		SQL is a programming language for databases. It has been mostly standardised between different
		database systems, so it looks nearly the same regardless of whether you are connecting to
		MySQL or PostgreSQL or (as we are) SQLite. We will use it to set up our database initially,
		save information to our blog, and query information from our blog.
	</p>
</blockquote>

<p>
	Broadly, databases are stored in terms of <em>tables</em>, <em>columns</em> and <em>rows</em>. Each
	different kind of data we wish to store needs its own table, but to start with, we only have one:
	a post. The <code>CREATE TABLE</code> statement specifies which properties we want a post to have,
	namely:
</p>

<?php if (showTodoMessages()): ?>
	<div class="todo">
		Shall I rebase <code>user_id</code> out of the code until later? This might be confusing.
	</div>
<?php endif ?>

<ul>
	<li>id: a unique identifier to help us tell posts apart</li>
	<li>title: the heading</li>
	<li>body: the main text of the article</li>
	<li>user_id: which user created the article</li>
	<li>created_at: when the article was created</li>
	<li>updated_at: when the article was updated</li>
</ul>

<p>
	A blog post is therefore just a row added to the posts table, since each row has space to store
	all of these values. Once the table is created, we also create some dummy article data, using
	<code>INSERT</code>. The format of this command, as used in the SQL script, is simply thus:
</p>

<p>
	<code>
		INSERT INTO table_name (column_1, column_2, ...) VALUES (value_1, value_2, ...);
	</code>
</p>

<p>
	Now, the SQL file won't do anything on its own: we need a program to send the commands to
	the database. This is where the "install" file comes in; we'll run that whenever we want to
	set up the blog (or to wipe it and start again). I'll describe its broad features here, but
	do also read the comments in the code.
</p>

<?php if (showTodoMessages()): ?>
	<div class="todo">
		Re-running the installer on a fresh vhost just now resulted in permission errors when
		trying to create the file. Can we add a check in the script?
	</div>
<?php endif ?>

<p>
	The first half of the code is written in PHP. Here, we use a series of <code>if</code> statements
	to ensure everything goes smoothly. The variable <code>$error</code> is set to an error message
	if something goes wrong. Here are the steps we take:
</p>

<ul>
	<li>Ensure the database has not been created in the "data.sqlite" file. If it has, we require the
		file to be deleted manually, so that it is harder to accidentally overwrite data.
	</li>
	<li>
		SQLite will work fine with just an empty file, so we create one with <code>touch</code> and
		report if there was any problems doing that (such as being disallowed by file system
		permissions).
	</li>
	<li>
		We then read the SQL script in using <code>file_get_contents()</code> and report an error
		if the file cannot be found (this is unlikely, but it is good practice to check
		everything that can go wrong!).
	</li>
	<li>
		We then try running the SQL commands using <code>$pdo->exec()</code> and report any issues
		with that.
	</li>
	<li>
		Finally, we count the number of post rows we have created.
	</li>
</ul>

<p>
	The second half of the file (from <code>&lt;!DOCTYPE html&gt;</code>) presents the results of
	the script, in HTML.
</p>
<p>So, if you have not already tried it, visit <code>http://localhost/install.php</code> in your
	browser, and make sure some posts are created. If you want to re-run it, delete the data.sqlite
	file manually and refresh your browser page.
</p>

__NEWFILE__

<h2>Using real data</h2>

<p>
	Since we now have some data in our database, we can change our home page to render that data, rather
	than the mock data it has now. It's worth noting though that the process of designing the page
	with dummy data hasn't been a waste of time; using a mock-up is often a valuable part of deciding what
	a page should contain, and where those elements should go. So, make these changes next:
</p>

<?php renderDiff('c651ad75057710db2d121bb3a63ceb33e8d9880e') ?>

<?php if (showTodoMessages()): ?>
	<div class="todo">
		There's no value in adding <code>realpath</code> to the code on line 4.
	</div>
<?php endif ?>

<p>
	The first few lines determine the file path to the database, and then we create a new PDO object with
	<code>new PDO</code>, which we can use to access the database. We then use the <code>query</code>
	method to run a SQL statement that reads the posts from the database.
</p>

<blockquote class="sidebar">
	<div class="heading">
		<p>What is a SELECT statement?</p>
	</div>
	<p>
		The <code>SELECT</code> command is used to read from the database. For a single table, it takes a
		format like this:
	</p>
		
	<pre><code>SELECT
	(column names in a list)
FROM
	(table)
WHERE
	(condition)
ORDER BY
	(column names to sort on)</code></pre>

	<p>
		The <code>WHERE</code> is optional, and is useful if we want to filter on some particular
		feature of each row.
	</p>

	<p>The statement is often written on a single line, but it can be split up as here, for readability.</p>
</blockquote>

<p>
	So, refresh your browser's view of <code>http://localhost/index.php</code>, and ensure that your
	new changes render the posts from the database without errors. I'll then explain what is happening.
</p>

<p>
	After connecting to the database, the query is used to retrieve column values for each table row,
	returning ordering the rows in <code>created_at DESC</code> (i.e. in reverse creation order, or most
	recent first). It then enters a loop (in this case a <code>while</code>) to render all the posts it
	finds.
</p>

<p>
	We use <code>$stmt->fetch()</code> to read the next available row, until the point when there are no
	rows left. When that happens, this method will return false and the loop will exit.
</p>

<p>
	For every row, there are two observations worth making. Firstly, rows are returned in an array, so we
	access them using the array syntax such as <code>$row['title']</code>. Secondly, you'll see that
	where text strings are output, they are wrapped in the <code>htmlspecialchars()</code> function. The
	reason for this is that, if user input (a blog title or blog post in this case) contains angle brackets,
	it could break the HTML used in the page layout, and worse, might let a user inject unauthorised
	JavaScript that would be run on other people's computers.
</p>

<p>
	You'll notice that most of the PHP code to deal with the database side of things is in the top half
	of the file, and the second half is predominantly HTML. This isn't an accident: this arrangement creates
	a healthy separation between the two, which makes each easier to work with. Of course, there are a few
	cases where dynamic output is required inside the HTML, but these are kept deliberately short.
</p>

<div class="intermission">~</div>

<p>
	The next step is to create a page to show individual posts. Add the following file:
</p>

<?php renderDiff('536e6c16d114954fd16d98566a73d9aabaaba338') ?>

<p>
	Now, it is our intention to link this page from individual posts on the home page. However, we've
	not quite done that bit yet, so let's visit the new page manually, in order to test it. Open a
	new tab, paste the link <code>http://localhost/view-post.php</code> into the address
	bar, and check that a simple post appears.
</p>

<p>
	
	The connection to the database is the same as before, but we now have a <code>WHERE</code> clause
	in our <code>SELECT</code> statement, and we are we are now using <code>prepare</code> and
	<code>execute</code> to send the statement to the database driver.
</p>
	
<p>
	Let's take the <code>WHERE</code> statement first. In the home page, we ran a query without
	this, because we wanted everything in the table. However it is more often the case that we
	want to limit returned rows to those matching one or more conditions. This is where the
	<code>WHERE</code> comes in. For our new page, we only want rows that have a specific id (and
	since "id" is unique, we know we won't get more than one).
</p>

<p>
	You'll notice that "id" is fixed to 1 (i.e. the first post). We'll fix that later, since of
	course this should depend on the post the user clicks on.
</p>

<p>
	The other change is swapping out the call to <code>query</code> with two new methods.
	<code>prepare</code> is used to set up the statement, and indicates with a colon where values
	should go (i.e. ":id"). The <code>execute</code> statement then runs the query, swapping
	place-holders with real values (in this case, the number 1). This technique is known as
	<em>parameterisation</em>, and is a good way to inject user-supplied input in a secure manner
	(the post ID is not yet user-supplied, but it soon will be).
</p>

<p>
	In fact, let's wire in the post page now. Make the following changes, and test that clicking
	on each 'Read more' link shows the appropriate post.
</p>

<?php if (showTodoMessages()): ?>
	<div class="todo">
		The code in view-post.php says the post ID is sanitised when it retrieved from GET, but
		this is not the case.
	</div>
<?php endif ?>

<?php renderDiff('c9b46d47f522cfe625d5a18a8e70a80425406d08') ?>

<p>
	Alright, so let's make some nice easy changes now. A look at our index.php and view-post.php
	files shows that our blog title and synopsis is repeated in both files. That's not good, since
	if these things need to be amended, we need to change them more than once. Happily, the
	solution is easy: we create a PHP file for the duplicated snippet, and then use
	<code>require</code> to pull it in.
</p>

<?php renderDiff('f2b8629358c962b9d2b2cc508edff4759e9edb86') ?>

<p>
	Once that is done, we can see there is still some duplication, this time with the database
	PHP code. So, let's fix that too! You'll notice here that we're using a subfolder for "lib";
	this is a very common name for library code folders.
</p>

<?php renderDiff('2d30343a759c27e7e11e5153b7f0f46c58fd4b32') ?>

__NEWFILE__

<h2>Adding more features</h2>

<p>
	It is normal practice to link the main heading of a website to the home page, as this makes
	for a consistent navigation experience. So, let's do that now:
</p>

<?php renderDiff('6b674108db59a4763b772bad8166888833f99205') ?>

<p>
	Next, let us add in some logic that interprets two carriage-returns in a post as a paragraph
	break. Here we go:
</p>

<?php if (showTodoMessages()): ?>
	<div class="todo">
		We have a closing <code>div</code> here that probably has only changed in whitespace terms.
		Remove this error.
	</div>
<?php endif ?>

<?php renderDiff('2db998b878d2c34119591c68cc754ea2fb756f4b') ?>

<p>
	Now, the default date style used around the application isn't very readable, so let's
	improve that now:
</p>

<?php renderDiff('c0fd766e3056011a52a256c6469f4b9af99a47cf') ?>

<p>
	Now we've done a bit of tidying, let's tackle a bigger item of functionality. We need
	to allow users to comment on articles, so let's make the necessary database changes to
	prepare for that:
</p>

<?php renderDiff('60e4d9305ee4ee69f1d3289ce7f8016b01c689f0') ?>

<p>
	Since this involves database changes, we'll need to delete our database file, and re-run
	the installer. So, delete the file in "data/data.sqlite" and then reinstall by visiting
	<code>http://localhost/install.php</code> again.
</p>

<p>
	You might ask why we are putting so much effort into an installer when we're nowhere
	near having a piece of finished software. The answer is that this installer is for us,
	the developers, and not for end users. Thus, it is something we want to set up reasonably
	early in our development lifecycle; whenever a database change is made, we want to be able
	to recreate our useful test data quickly and easily.
</p>

<p>
	Now we're ready to start adding some comment-related changes. To start with, let's add
	a count of comments on the front page. This uses the SQL command `COUNT()` to count the
	number of rows that would be returned by a query:
</p>

<?php renderDiff('1dd2779ee8966241f1e609d08e0b7864c7632aef') ?>

<p>
	Also, we'll add a comment listing to individual post pages:
</p>

<?php renderDiff('e082b342676bfaef352d75465f684379ef3d4f35') ?>

