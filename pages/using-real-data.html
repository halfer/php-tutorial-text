

<h2>Using real data</h2>

<p>
	Since we now have some data in our database, we can change our home page to render that data, rather
	than the mock data it has now. It's worth noting though that the process of designing the page
	with dummy data hasn't been a waste of time; using a mock-up is often a valuable part of deciding what
	a page should contain, and where those elements should go. So, make these changes next:
</p>

<?php renderDiff('c651ad75057710db2d121bb3a63ceb33e8d9880e') ?>

<div class="todo">
	There's no value in adding <code>realpath</code> to the code on line 4.
</div>

<p>
	The first few lines determine the file path to the database, and then we create a new PDO object with
	<code>new PDO</code>, which we can use to access the database. We then use the <code>query</code>
	method to run a SQL statement that reads the posts from the database.
</p>

<blockquote class="sidebar">
	<div class="heading">
		<p>What is a SELECT statement?</p>
	</div>
	<p>
		The <code>SELECT</code> command is used to read from the database. For a single table, it takes a
		format like this:
	</p>
		
	<pre><code>SELECT
	(column names in a list)
FROM
	(table)
WHERE
	(condition)
ORDER BY
	(column names to sort on)</code></pre>

	<p>
		The <code>WHERE</code> is optional, and is useful if we want to filter on some particular
		feature of each row.
	</p>

	<p>The statement is often written on a single line, but it can be split up as here, for readability.</p>
</blockquote>

<p>
	So, refresh your browser's view of <code>http://localhost/index.php</code>, and ensure that your
	new changes render the posts from the database without errors. I'll then explain what is happening.
</p>

<p>
	After connecting to the database, the query is used to retrieve column values for each table row,
	returning ordering the rows in <code>created_at DESC</code> (i.e. in reverse creation order, or most
	recent first). It then enters a loop (in this case a <code>while</code>) to render all the posts it
	finds.
</p>

<p>
	We use <code>$stmt->fetch()</code> to read the next available row, until the point when there are no
	rows left. When that happens, this method will return false and the loop will exit.
</p>

<p>
	For every row, there are two observations worth making. Firstly, rows are returned in an array, so we
	access them using the array syntax such as <code>$row['title']</code>. Secondly, you'll see that
	where text strings are output, they are wrapped in the <code>htmlspecialchars()</code> function. The
	reason for this is that, if user input (a blog title or blog post in this case) contains angle brackets,
	it could break the HTML used in the page layout, and worse, might let a user inject unauthorised
	JavaScript that would be run on other people's computers.
</p>

<p>
	You'll notice that most of the PHP code to deal with the database side of things is in the top half
	of the file, and the second half is predominantly HTML. This isn't an accident: this arrangement creates
	a healthy separation between the two, which makes each easier to work with. Of course, there are a few
	cases where dynamic output is required inside the HTML, but these are kept deliberately short.
</p>

<div class="intermission">~</div>

<p>
	The next step is to create a page to show individual posts. Add the following file:
</p>

<?php renderDiff('536e6c16d114954fd16d98566a73d9aabaaba338') ?>

<p>
	Now, it is our intention to link this page from individual posts on the home page. However, we've
	not quite done that bit yet, so let's visit the new page manually, in order to test it. Open a
	new tab, paste the link <code>http://localhost/view-post.php</code> into the address
	bar, and check that a simple post appears.
</p>

<p>
	
	The connection to the database is the same as before, but we now have a <code>WHERE</code> clause
	in our <code>SELECT</code> statement, and we are we are now using <code>prepare</code> and
	<code>execute</code> to send the statement to the database driver.
</p>
	
<p>
	Let's take the <code>WHERE</code> statement first. In the home page, we ran a query without
	this, because we wanted everything in the table. However it is more often the case that we
	want to limit returned rows to those matching one or more conditions. This is where the
	<code>WHERE</code> comes in. For our new page, we only want rows that have a specific id (and
	since "id" is unique, we know we won't get more than one).
</p>

<p>
	You'll notice that "id" is fixed to 1 (i.e. the first post). We'll fix that later, since of
	course this should depend on the post the user clicks on.
</p>

<p>
	The other change is swapping out the call to <code>query</code> with two new methods.
	<code>prepare</code> is used to set up the statement, and indicates with a colon where values
	should go (i.e. ":id"). The <code>execute</code> statement then runs the query, swapping
	place-holders with real values (in this case, the number 1). This technique is known as
	<em>parameterisation</em>, and is a good way to inject user-supplied input in a secure manner
	(the post ID is not yet user-supplied, but it soon will be).
</p>

<p>
	In fact, let's wire in the post page now. Make the following changes, and test that clicking
	on each 'Read more' link shows the appropriate post.
</p>

<div class="todo">
	The code in view-post.php says the post ID is sanitised when it retrieved from GET, but
	this is not the case.
</div>
<?php renderDiff('c9b46d47f522cfe625d5a18a8e70a80425406d08') ?>

<p>
	Alright, so let's make some nice easy changes now. A look at our index.php and view-post.php
	files shows that our blog title and synopsis is repeated in both files. That's not good, since
	if these things need to be amended, we need to change them more than once. Happily, the
	solution is easy: we create a PHP file for the duplicated snippet, and then use
	<code>require</code> to pull it in.
</p>

<?php renderDiff('f2b8629358c962b9d2b2cc508edff4759e9edb86') ?>

<p>
	Once that is done, we can see there is still some duplication, this time with the database
	PHP code. So, let's fix that too! You'll notice here that we're using a subfolder for "lib";
	this is a very common name for library code folders.
</p>

<?php renderDiff('2d30343a759c27e7e11e5153b7f0f46c58fd4b32') ?>

