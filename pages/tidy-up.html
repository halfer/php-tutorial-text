

<h2>Tidy up</h2>

<?php if (showTodoMessages()): ?>
	<div class="comment note">
		Have I over-iterated the point about refactoring? Read through earlier material.
	</div>
<?php endif ?>

<p>
	We've got a nice set of features working, but there are a good number of improvements and
	refactoring changes that can be made. Doing these periodically can make for easier and
	happier development, which in turn can improve your development efficiency.
</p>

<p>
	The first change is two-fold: pages were replicating some information in the header, and
	various items (the top menu bar and system messages) were using inline style rules rather than
	using class rules that need only be written once.
</p>

<?php renderDiffFromComment('Centralise CSS, switch various inline styles to classes') ?>

<p>
	Let's take a better look at the second change. Some of the original code was written like
	this:
</p>

<blockquote>
	<code>&lt;div style="border: 1px solid #ff6666; padding: 6px;"&gt; &hellip; &lt;/div&gt;</code>
</blockquote>

<p>
	The purpose of the <code>style</code> attribute to specify CSS rules (otherwise known as
	style rules) to the HTML within. Firstly, we have the <code>border</code> rule, which says
	the content (an error message) should have a red border rendered in an unbroken line, and
	the <code>padding</code> means that there should be six pixels of gap between the border and
	the box around the content.
</p>

<p>
	However, having to write that for every error message takes a bit of effort, and it's a
	pain if we decide that error messages should have a magenta border and not a red one. Thus,
	it makes life easier if we write this instead:
</p>

<blockquote>
	<code>&lt;div class="error box"&gt; &hellip; &lt;/div&gt;</code>
</blockquote>

<p>
	That applies two rules to the block: one called <code>error</code> and another called
	<code>box</code>. That's much easier to remember, easier to read, and &mdash; since we
	centralise the definitions in <span class="filename">assets/main.css</span> &mdash; easier
	to change if we have to.
</p>

<p>
	While we are dealing with CSS changes, let's add a few more. Here we add some rules for
	article synopses, titles and dates on the home page, and comments on individual blog posts.
</p>

<?php renderDiffFromComment('Various CSS improvements') ?>

<p>
	You may have noticed that some function calls that need to access the database create their
	own connection rather than use one that we've already created. For low-volume systems this
	might not matter a great deal, but programmers hate this sort of inefficiency, and where it is
	trivial to fix, we should.
</p>

<?php renderDiffFromComment('Add a PDO param to functions, for consistency') ?>

<p>
	Now we improve the appearance of the comment form. It's worth opening up an article page
	prior to making the improvements, so you can refresh it after the CSS is in place. This will
	allow you to see the change quickly.
</p>

<?php renderDiffFromComment('Tidy up CSS for comment form') ?>

<?php if (showTodoMessages()): ?>
	<div class="comment note">
		I expect the user table has moved in order to get the constraint to work?
	</div>
<?php endif ?>

<p>
	We now turn our attention to an improvement to the database. This consists of the tables
	<code>post</code> and <code>user</code>, for blog posts and authors respectively. When
	creating a post record, we insert our automatically generated <code>user.id</code> in
	<code>post.user_id</code> to store which user has authored it (of course, we only have one 
	user in our test data, but in practice we might have several).
</p>

<p>
	However, it is possible to insert any number in <code>post.user_id</code>, so if we have
	an undiscovered bug in our code, it might cause a non-existent user primary key to be stored
	here. Since we rely on values here always pointing to a user row, if a bad value were to get
	in, it might crash our application.
</p>

<p>
	To protect against that scenario, many database systems will allow the use of <em>foreign key
	constraints</em>. These allow us to specify that values inserted into a particular column must
	exist in another column belonging to another table, and that an error must occur if this
	condition is not met. SQLite offers this feature, although it is unusual in that it needs to
	be turned on explicitly, using the <code>PRAGMA</code> command.
</p>

<p>
	So, let's make these changes:
</p>

<?php if (showTodoMessages()): ?>
	<div class="todo note">
		If we have an existing database, doesn't deleting the <code>user</code> table result
		in a constraint violation? Or is that just applied to <code>DELETE</code> only in
		SQLite? Try it!
	</div>
<?php endif ?>

<?php renderDiffFromComment('Enable foreign key constraints') ?>

<p>
	Here's what is new:
</p>

<ul>
	<li>
		Since we want posts to reference users, we need a user first. Thus, I've swapped the
		order around, so the test user is created before the test post</li>
	<li>
		We now need the test user to be created immediately in order to satisfy the foreign key
		constraint, so we <code>INSERT</code> that in the script with a dummy hash value, and
		<code>UPDATE</code> it afterwards with the real hash generated in PHP</li>
	<li>
		Now when we make database connections in <span class="filename">common.php</span>, the
		first thing we do is to switch on foreign key constraints</li>
</ul>

<p>
	The last change is related to security. Since all of our files are in the web server's
	public directory, a user who knows our directory structure would be able to download files
	that we didn't intend to make accessible. Since SQLite uses a single file to store its data,
	and since this file is often stored in a web-accessible location, it is of particular
	importance to lock this down.
</p>

<?php renderDiffFromComment('Prevent direct downloaders nicking the database etc') ?>

